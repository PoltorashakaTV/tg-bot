import os
import telebot
import sqlite3

# --- –¢–æ–∫–µ–Ω ---
TOKEN = os.environ.get("BOT_TOKEN")
if not TOKEN:
    raise Exception("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")

bot = telebot.TeleBot(TOKEN)

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ---
def init_db():
    conn = sqlite3.connect("gamers.db")
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY,
            nick TEXT NOT NULL
        )
    """)
    conn.commit()
    conn.close()

init_db()

# --- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ ---
def save_user_nick(user_id, nick):
    conn = sqlite3.connect("gamers.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO users (id, nick)
        VALUES (?, ?)
        ON CONFLICT(id) DO UPDATE SET nick=excluded.nick
    """, (user_id, nick))
    conn.commit()
    conn.close()

# --- –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫ ---
def get_user_nick(user_id):
    conn = sqlite3.connect("gamers.db")
    cursor = conn.cursor()
    cursor.execute("SELECT nick FROM users WHERE id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else None

# --- –ö–æ–º–∞–Ω–¥–∞ /–Ω–∏–∫ (–¥–ª—è –≤—Å–µ—Ö) ---
@bot.message_handler(commands=['–Ω–∏–∫'])
def save_nick(message):
    parts = message.text.split(maxsplit=1)
    if len(parts) < 2 or not parts[1].strip():
        bot.reply_to(message, "–ù–∞–ø–∏—à–∏: /–Ω–∏–∫ [—Ç–≤–æ–π –Ω–∏–∫]")
        return
    nick = parts[1].strip()
    save_user_nick(message.from_user.id, nick)
    bot.reply_to(message, f"‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª! –¢–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫: {nick}")

# --- –ö–æ–º–∞–Ω–¥–∞ /–∫—Ç–æ ---
@bot.message_handler(commands=['–∫—Ç–æ'])
def who_is(message):
    if not message.reply_to_message:
        bot.reply_to(message, "‚ùå –û—Ç–≤–µ—Ç—å —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞.")
        return
    target = message.reply_to_message.from_user
    nick = get_user_nick(target.id)
    if nick:
        bot.reply_to(message, f"üéÆ –ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target.first_name}: {nick}")
    else:
        bot.reply_to(message, f"‚ùì {target.first_name} –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª –Ω–∏–∫ —á–µ—Ä–µ–∑ /–Ω–∏–∫")

# --- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å /all ---
ALLOWED_USERS = ["Beck_rus", "VolshebnikTYI", "Alice_moove"]  # —Å—é–¥–∞ –∞–π–¥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /all

# --- –ö–æ–º–∞–Ω–¥–∞ /all (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö) ---
@bot.message_handler(commands=['all'])
def mention_all(message):
    if message.from_user.id not in ALLOWED_USERS:
        bot.reply_to(message, "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.")
        return

    conn = sqlite3.connect("gamers.db")
    cursor = conn.cursor()
    cursor.execute("SELECT nick FROM users")
    nicks = cursor.fetchall()
    conn.close()

    if nicks:
        mentions = " ".join([f"@{nick[0]}" for nick in nicks])
        bot.send_message(message.chat.id, f"üéÆ –í–Ω–∏–º–∞–Ω–∏–µ –≤—Å–µ–º! {mentions}")
    else:
        bot.send_message(message.chat.id, "‚ùå –ù–∏–∫—Ç–æ –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª —Å–≤–æ–π –Ω–∏–∫ —á–µ—Ä–µ–∑ /–Ω–∏–∫")

print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")

bot.infinity_polling()
